name: Code Quality

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  # Job 1: SwiftLint Analysis
  swiftlint:
    name: SwiftLint
    runs-on: macos-14
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install SwiftLint
        run: |
          brew install swiftlint
          
      - name: SwiftLint Version
        run: swiftlint version
        
      - name: Run SwiftLint
        run: |
          swiftlint lint --reporter github-actions-logging
        continue-on-error: true
        
      - name: Generate SwiftLint Report
        if: always()
        run: |
          swiftlint lint --reporter json > swiftlint-report.json || true
          swiftlint lint --reporter html > swiftlint-report.html || true
          
      - name: Upload SwiftLint Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: swiftlint-reports
          path: |
            swiftlint-report.json
            swiftlint-report.html
          retention-days: 30

  # Job 2: SwiftFormat Check
  swiftformat:
    name: SwiftFormat
    runs-on: macos-14
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install SwiftFormat
        run: |
          brew install swiftformat
          
      - name: SwiftFormat Version
        run: swiftformat --version
        
      - name: Check Code Formatting
        run: |
          swiftformat --lint --verbose .
        continue-on-error: true

  # Job 3: Code Quality Report
  quality-report:
    name: Code Quality Report
    runs-on: ubuntu-latest
    needs: [swiftlint, swiftformat]
    if: always() && github.event_name == 'pull_request'
    
    steps:
      - name: Download SwiftLint Report
        uses: actions/download-artifact@v4
        with:
          name: swiftlint-reports
        continue-on-error: true
        
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const swiftlintResult = '${{ needs.swiftlint.result }}';
            const swiftformatResult = '${{ needs.swiftformat.result }}';
            
            let message = '## üìã Code Quality Report\n\n';
            
            // SwiftLint status
            if (swiftlintResult === 'success') {
              message += '‚úÖ **SwiftLint**: No issues found\n';
            } else {
              message += '‚ö†Ô∏è **SwiftLint**: Issues detected (see workflow logs)\n';
            }
            
            // SwiftFormat status
            if (swiftformatResult === 'success') {
              message += '‚úÖ **SwiftFormat**: Code is properly formatted\n';
            } else {
              message += '‚ö†Ô∏è **SwiftFormat**: Formatting issues detected\n';
            }
            
            // Try to read SwiftLint JSON report
            try {
              if (fs.existsSync('swiftlint-report.json')) {
                const report = JSON.parse(fs.readFileSync('swiftlint-report.json', 'utf8'));
                if (Array.isArray(report) && report.length > 0) {
                  message += `\n### SwiftLint Issues (${report.length})\n\n`;
                  const topIssues = report.slice(0, 10);
                  topIssues.forEach((issue, index) => {
                    const severity = issue.severity === 'error' ? 'üî¥' : 'üü°';
                    message += `${index + 1}. ${severity} **${issue.rule_id}** in \`${issue.file}\` (line ${issue.line})\n`;
                    message += `   \`\`\`\n   ${issue.reason}\n   \`\`\`\n`;
                  });
                  if (report.length > 10) {
                    message += `\n_...and ${report.length - 10} more issues_\n`;
                  }
                }
              }
            } catch (error) {
              console.log('Could not parse SwiftLint report:', error.message);
            }
            
            message += '\n---\n';
            message += `*Workflow run: [#${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

  # Job 4: Code Quality Gate
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [swiftlint, swiftformat]
    if: always()
    
    steps:
      - name: Check Quality Status
        run: |
          echo "SwiftLint: ${{ needs.swiftlint.result }}"
          echo "SwiftFormat: ${{ needs.swiftformat.result }}"
          
          # For now, we allow warnings but track them
          # In the future, you can make this stricter by failing on warnings
          if [ "${{ needs.swiftlint.result }}" == "failure" ] || [ "${{ needs.swiftformat.result }}" == "failure" ]; then
            echo "‚ö†Ô∏è Code quality checks completed with warnings"
            exit 0  # Allow to continue but log warnings
          else
            echo "‚úÖ All code quality checks passed"
            exit 0
          fi
