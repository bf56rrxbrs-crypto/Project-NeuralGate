name: Performance Metrics

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  SWIFT_VERSION: '5.9'

jobs:
  # Job 1: Build Time Metrics
  build-metrics:
    name: Build Time Metrics
    runs-on: macos-14
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        
      - name: Setup Swift
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: ${{ env.SWIFT_VERSION }}
          
      - name: Measure Clean Build Time
        run: |
          echo "ðŸ“Š Measuring clean build time..."
          START_TIME=$(date +%s)
          swift build --verbose 2>&1 | tee build-output.log
          END_TIME=$(date +%s)
          BUILD_TIME=$((END_TIME - START_TIME))
          
          echo "Clean Build Time: ${BUILD_TIME}s" | tee build-time.txt
          echo "BUILD_TIME=${BUILD_TIME}" >> $GITHUB_ENV
          
      - name: Measure Incremental Build Time
        run: |
          echo "ðŸ“Š Measuring incremental build time..."
          # Touch a source file to trigger incremental build
          touch Sources/NeuralGate/*.swift 2>/dev/null || true
          
          START_TIME=$(date +%s)
          swift build --verbose 2>&1 | tee incremental-build-output.log
          END_TIME=$(date +%s)
          INCREMENTAL_TIME=$((END_TIME - START_TIME))
          
          echo "Incremental Build Time: ${INCREMENTAL_TIME}s" | tee -a build-time.txt
          echo "INCREMENTAL_TIME=${INCREMENTAL_TIME}" >> $GITHUB_ENV
          
      - name: Package Size Analysis
        run: |
          echo "ðŸ“¦ Analyzing package size..."
          du -sh .build/debug > package-size.txt
          du -h --max-depth=1 .build/debug >> package-size.txt
          cat package-size.txt
          
      - name: Upload Build Metrics
        uses: actions/upload-artifact@v6
        with:
          name: build-metrics
          path: |
            build-time.txt
            package-size.txt
            build-output.log
          retention-days: 90

  # Job 2: Test Performance Metrics
  test-metrics:
    name: Test Performance Metrics
    runs-on: macos-14
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        
      - name: Setup Swift
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: ${{ env.SWIFT_VERSION }}
          
      - name: Build Tests
        run: swift build --build-tests
        
      - name: Measure Test Execution Time
        run: |
          echo "ðŸ§ª Measuring test execution time..."
          START_TIME=$(date +%s)
          swift test --verbose 2>&1 | tee test-output.log
          END_TIME=$(date +%s)
          TEST_TIME=$((END_TIME - START_TIME))
          
          echo "Test Execution Time: ${TEST_TIME}s" | tee test-time.txt
          echo "TEST_TIME=${TEST_TIME}" >> $GITHUB_ENV
          
      - name: Extract Test Statistics
        run: |
          echo "ðŸ“Š Extracting test statistics..."
          
          # Count test cases
          TEST_COUNT=$(grep -c "Test Case" test-output.log || echo "0")
          echo "Total Tests: ${TEST_COUNT}" | tee test-stats.txt
          
          # Extract passed/failed
          PASSED=$(grep -c "passed" test-output.log || echo "0")
          echo "Passed: ${PASSED}" | tee -a test-stats.txt
          
          cat test-stats.txt
          
      - name: Upload Test Metrics
        uses: actions/upload-artifact@v6
        with:
          name: test-metrics
          path: |
            test-time.txt
            test-stats.txt
            test-output.log
          retention-days: 90

  # Job 3: Memory and Performance Profiling
  performance-profiling:
    name: Performance Profiling
    runs-on: macos-14
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        
      - name: Setup Swift
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: ${{ env.SWIFT_VERSION }}
          
      - name: Build with Profiling
        run: |
          swift build -c release --verbose
          
      - name: Analyze Binary Size
        run: |
          echo "ðŸ“ Analyzing binary sizes..."
          find .build/release -type f -name "*.dylib" -o -name "*.a" | while read file; do
            size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
            size_mb=$(echo "scale=2; $size / 1024 / 1024" | bc)
            echo "$(basename $file): ${size_mb} MB"
          done | tee binary-sizes.txt
          
      - name: Memory Footprint Estimation
        run: |
          echo "ðŸ’¾ Estimating memory footprint..."
          # This is a basic estimation - in production, you'd use Instruments
          find .build/release -type f \( -name "*.dylib" -o -name "*.a" \) -exec ls -lh {} \; | \
            awk '{sum+=$5} END {print "Estimated Memory: " sum " bytes"}' | tee memory-footprint.txt
          
      - name: Upload Profiling Data
        uses: actions/upload-artifact@v6
        with:
          name: performance-profiling
          path: |
            binary-sizes.txt
            memory-footprint.txt
          retention-days: 90

  # Job 4: Metrics Aggregation and Reporting
  metrics-report:
    name: Metrics Report
    runs-on: ubuntu-latest
    needs: [build-metrics, test-metrics, performance-profiling]
    if: always()
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Download All Metrics
        uses: actions/download-artifact@v7
        with:
          path: metrics
          
      - name: Generate Metrics Report
        run: |
          echo "# ðŸ“Š Performance Metrics Report" > metrics-report.md
          echo "" >> metrics-report.md
          echo "**Run Date**: $(date)" >> metrics-report.md
          echo "**Commit**: ${GITHUB_SHA::7}" >> metrics-report.md
          echo "**Branch**: ${GITHUB_REF_NAME}" >> metrics-report.md
          echo "" >> metrics-report.md
          
          # Build Metrics
          echo "## ðŸ—ï¸ Build Metrics" >> metrics-report.md
          echo "" >> metrics-report.md
          if [ -f metrics/build-metrics/build-time.txt ]; then
            cat metrics/build-metrics/build-time.txt >> metrics-report.md
          fi
          echo "" >> metrics-report.md
          
          # Test Metrics
          echo "## ðŸ§ª Test Metrics" >> metrics-report.md
          echo "" >> metrics-report.md
          if [ -f metrics/test-metrics/test-stats.txt ]; then
            cat metrics/test-metrics/test-stats.txt >> metrics-report.md
          fi
          if [ -f metrics/test-metrics/test-time.txt ]; then
            cat metrics/test-metrics/test-time.txt >> metrics-report.md
          fi
          echo "" >> metrics-report.md
          
          # Performance Profiling
          echo "## ðŸ“ Performance Profiling" >> metrics-report.md
          echo "" >> metrics-report.md
          if [ -f metrics/performance-profiling/binary-sizes.txt ]; then
            echo "### Binary Sizes" >> metrics-report.md
            cat metrics/performance-profiling/binary-sizes.txt >> metrics-report.md
          fi
          echo "" >> metrics-report.md
          
          # Package Size
          if [ -f metrics/build-metrics/package-size.txt ]; then
            echo "### Package Size" >> metrics-report.md
            cat metrics/build-metrics/package-size.txt >> metrics-report.md
          fi
          echo "" >> metrics-report.md
          
          cat metrics-report.md
          
      - name: Upload Metrics Report
        uses: actions/upload-artifact@v6
        with:
          name: metrics-report
          path: metrics-report.md
          retention-days: 90
          
      - name: Add to Job Summary
        run: |
          if [ -f metrics-report.md ]; then
            cat metrics-report.md >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            
            let message = '';
            if (fs.existsSync('metrics-report.md')) {
              message = fs.readFileSync('metrics-report.md', 'utf8');
            } else {
              message = '## ðŸ“Š Performance Metrics Report\n\n';
              message += 'Metrics data not available for this run.\n';
            }
            
            message += '\n---\n';
            message += `*Workflow run: [#${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

  # Job 5: Trend Analysis (requires historical data)
  trend-analysis:
    name: Trend Analysis
    runs-on: ubuntu-latest
    needs: metrics-report
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        
      - name: Download Metrics Report
        uses: actions/download-artifact@v7
        with:
          name: metrics-report
          
      - name: Store Historical Metrics
        run: |
          # Create metrics history directory if it doesn't exist
          mkdir -p .metrics-history
          
          # Copy current metrics with timestamp
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          cp metrics-report.md .metrics-history/metrics-${TIMESTAMP}.md || true
          
          # Keep only last 30 reports
          cd .metrics-history
          ls -t | tail -n +31 | xargs rm -f -- 2>/dev/null || true
          
      - name: Generate Trend Report
        run: |
          echo "ðŸ“ˆ Performance trends will be tracked over time"
          echo "Historical metrics are stored in .metrics-history/"
          # In the future, add visualization and trend analysis here
